<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spin Accuracy Game</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow-y: auto;
    }

    #game-container {
      max-width: 1200px;
      max-height: 90vh;
      width: 100%;
      background: rgba(30, 30, 46, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 255, 255, 0.3);
      position: relative;
      overflow-y: auto;
    }

    h1 {
      margin: 0 0 30px 0;
      text-align: center;
      font-size: 28px;
      color: #00ffff;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    /* HUD: round/score top bar */
    #hud {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      padding: 12px 16px;
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 12px;
      background: rgba(0, 20, 35, 0.5);
      box-shadow: inset 0 0 10px rgba(0, 255, 255, 0.1);
    }

    #hud .hud-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    #round-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      letter-spacing: 0.5px;
    }

    #round-dots {
      display: flex;
      gap: 8px;
    }

    .round-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid #00ffff;
      background: transparent;
      box-shadow: 0 0 6px rgba(0, 255, 255, 0.5);
    }

    .round-dot.completed {
      background: #00ffff;
    }

    .round-dot.current {
      background: #00ccff;
      box-shadow: 0 0 10px rgba(0, 204, 255, 0.9);
      transform: scale(1.1);
    }

    #hud .hud-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #score-label {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      letter-spacing: 0.5px;
    }

    #score-value {
      min-width: 80px;
      text-align: right;
      font-size: 24px;
      font-weight: 800;
      color: #00ffff;
      text-shadow: 0 0 12px rgba(0, 255, 255, 0.7);
    }

    #help-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      cursor: pointer;
      font-size: 24px;
      width: 35px;
      height: 35px;
      background: rgba(0, 255, 255, 0.2);
      border: 2px solid #00ffff;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    #help-btn:hover {
      background: rgba(0, 255, 255, 0.3);
      transform: scale(1.1);
    }

    #game-area {
      display: flex;
      flex-direction: row;
      gap: 20px;
      align-items: stretch;
      justify-content: center;
      min-height: 400px;
      margin-top: 20px;
    }

    .round-section {
      flex: 1;
      min-width: 280px;
      max-width: 350px;
      background: rgba(30, 30, 46, 0.5);
      border: 2px solid rgba(0, 255, 255, 0.2);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      transition: all 0.3s;
    }

    .round-section.active {
      background: rgba(30, 30, 46, 0.95);
      border-color: rgba(0, 255, 255, 0.5);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    .round-section.inactive {
      opacity: 0.4;
      pointer-events: none;
    }

    .round-section h3 {
      margin: 0 0 15px 0;
      text-align: center;
      color: #00ffff;
      font-size: 18px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.3);
      padding-bottom: 10px;
    }

    .round-section.inactive h3 {
      color: rgba(255, 255, 255, 0.3);
    }

    #game-area p {
      margin: 15px 0;
      font-size: 18px;
    }

    #game-area h2 {
      margin: 20px 0;
      color: #00ffff;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    .arrow-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 30px auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #arrow {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 80px solid #00ffff;
      transform-origin: 10px 80px;
      position: absolute;
      top: calc(50% - 80px);
      left: calc(50% - 10px);
      filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.8));
    }

    #ghost-arrow {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 80px solid rgba(255,255,255,0.25);
      transform-origin: 10px 80px;
      position: absolute;
      top: calc(50% - 80px);
      left: calc(50% - 10px);
      filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.3));
    }

    button {
      background: linear-gradient(135deg, #00ffff 0%, #0099cc 100%);
      border: 2px solid #00ffff;
      color: #111;
      padding: 12px 30px;
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 255, 255, 0.3);
      width: 100%;
    }

    button:hover:not(:disabled) {
      background: linear-gradient(135deg, #00ffff 0%, #00ccff 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    #modal-content {
      background: linear-gradient(135deg, #1e1e2e 0%, #252540 100%);
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 400px;
      text-align: left;
      border: 2px solid rgba(0, 255, 255, 0.3);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
    }

    #modal-content ul {
      margin: 15px 0;
      padding-left: 25px;
    }

    #modal-content li {
      margin: 10px 0;
      line-height: 1.6;
    }

    #modal-content button {
      width: 100%;
      margin-top: 20px;
    }

    #speed-config {
      background: rgba(0, 255, 255, 0.1);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    #speed-config label {
      display: block;
      margin-bottom: 15px;
      font-size: 18px;
      color: #00ffff;
      font-weight: bold;
    }

    #speed-slider {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
      margin: 15px 0;
    }

    #speed-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #00ffff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
    }

    #speed-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #00ffff;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
    }

    #speed-value {
      font-size: 24px;
      color: #00ffff;
      font-weight: bold;
      margin: 10px 0;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    #speed-info {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1 id="title">Spin Accuracy Game</h1>
    <div id="help-btn">?</div>

    <div id="hud" style="display: none;">
      <div class="hud-left">
        <span id="round-label">Round</span>
        <div id="round-dots"></div>
      </div>
      <div class="hud-right">
        <span id="score-label">Score</span>
        <div id="score-value">0</div>
      </div>
    </div>

    <div id="game-area">
      <div style="display: flex; flex-direction: column; align-items: center; width: 100%;">
        <div class="arrow-container" style="margin: 20px auto; width: 200px; height: 200px;">
          <div id="start-ghost-arrow"></div>
          <div id="start-arrow"></div>
        </div>
        <button id="start-btn">Start Game</button>
      </div>
    </div>
  </div>

  <div id="modal">
    <div id="modal-content">
      <p>Stop the arrow as close as possible to the starting angle!</p>
      <ul>
        <li>5 rounds total</li>
        <li>Each round: 15s limit</li>
        <li>0–90° error → +points</li>
        <li>91–180° error → -points</li>
      </ul>
      <button id="close-modal">Close</button>
    </div>
  </div>

  <script>
    const helpBtn = document.getElementById("help-btn");
    const modal = document.getElementById("modal");
    const closeModal = document.getElementById("close-modal");
    const gameArea = document.getElementById("game-area");

    let round = 0;
    let score = 0;
    let interval, startAngle, currentAngle;
    let isRunning = false;
    let rotationSpeed = 120; // deg/sec (base speed)
    let speedMultiplier = 3.0; // Speed multiplier for each round
    let startTime;
    let startPageRotationInterval; // For start page arrow rotation

    helpBtn.onclick = () => modal.style.display = "flex";
    closeModal.onclick = () => modal.style.display = "none";

    // HUD helpers
    function renderRoundDots(currentRound) {
      const dotsEl = document.getElementById('round-dots');
      if (!dotsEl) return;
      const total = 5;
      const parts = [];
      for (let i = 1; i <= total; i++) {
        const classes = ['round-dot'];
        if (i < currentRound) classes.push('completed');
        if (i === currentRound) classes.push('current');
        parts.push(`<span class="${classes.join(' ')}"></span>`);
      }
      dotsEl.innerHTML = parts.join('');
    }

    function updateHUD() {
      const scoreEl = document.getElementById('score-value');
      if (scoreEl) scoreEl.textContent = String(score);
      renderRoundDots(Math.max(1, Math.min(5, round || 1)));
    }

    // Initialize start page arrow rotation
    function initStartPageArrow() {
      const startArrow = document.getElementById("start-arrow");
      const startGhost = document.getElementById("start-ghost-arrow");
      
      if (!startArrow || !startGhost) return;

      // Set arrow styles (same as main arrow)
      const arrowHeight = 80;
      const arrowWidth = 10;
      startGhost.style.width = "0";
      startGhost.style.height = "0";
      startGhost.style.borderLeft = `${arrowWidth}px solid transparent`;
      startGhost.style.borderRight = `${arrowWidth}px solid transparent`;
      startGhost.style.borderBottom = `${arrowHeight}px solid rgba(255,255,255,0.25)`;
      startGhost.style.transformOrigin = `${arrowWidth}px ${arrowHeight}px`;
      startGhost.style.position = "absolute";
      startGhost.style.top = `calc(50% - ${arrowHeight}px)`;
      startGhost.style.left = `calc(50% - ${arrowWidth}px)`;
      startGhost.style.filter = "drop-shadow(0 0 4px rgba(255, 255, 255, 0.3))";

      startArrow.style.width = "0";
      startArrow.style.height = "0";
      startArrow.style.borderLeft = `${arrowWidth}px solid transparent`;
      startArrow.style.borderRight = `${arrowWidth}px solid transparent`;
      startArrow.style.borderBottom = `${arrowHeight}px solid #00ffff`;
      startArrow.style.transformOrigin = `${arrowWidth}px ${arrowHeight}px`;
      startArrow.style.position = "absolute";
      startArrow.style.top = `calc(50% - ${arrowHeight}px)`;
      startArrow.style.left = `calc(50% - ${arrowWidth}px)`;
      startArrow.style.filter = "drop-shadow(0 0 8px rgba(0, 255, 255, 0.8))";

      // Fast rotation (360 deg/sec)
      const fastSpeed = 360; // deg/sec
      let startPageAngle = 0;
      const startPageStartTime = performance.now();

      function rotateStartArrow() {
        const delta = (performance.now() - startPageStartTime) / 1000;
        startPageAngle = (delta * fastSpeed) % 360;
        startArrow.style.transform = `rotate(${startPageAngle}deg)`;
        startPageRotationInterval = requestAnimationFrame(rotateStartArrow);
      }

      startPageRotationInterval = requestAnimationFrame(rotateStartArrow);
    }

    // Start arrow rotation when page loads
    window.addEventListener('load', () => {
      setTimeout(initStartPageArrow, 100);
    });

    function startGame() {
      // Stop start page rotation
      if (startPageRotationInterval) {
        cancelAnimationFrame(startPageRotationInterval);
        startPageRotationInterval = null;
      }
      
      // Show HUD when game starts
      const hud = document.getElementById('hud');
      if (hud) hud.style.display = 'flex';

      round = 0;
      score = 0;
      speedMultiplier = 3.0;
      updateHUD();
      
      // Create 3 sections layout
      gameArea.innerHTML = `
        <div class="round-section inactive" id="speed-config-section">
          <h3>1. Speed Setup</h3>
          <div id="speed-config-content"></div>
        </div>
        <div class="round-section inactive" id="game-section">
          <h3>2. Game</h3>
          <div id="game-content"><p style="color: rgba(255,255,255,0.5); text-align: center; margin-top: 50px;">Start after setting speed</p></div>
        </div>
        <div class="round-section inactive" id="result-section">
          <h3>3. Round Result</h3>
          <div id="result-content"><p style="color: rgba(255,255,255,0.5); text-align: center; margin-top: 50px;">Shown after the game ends</p></div>
        </div>
      `;
      
      // Initialize first round
      nextRound();
    }

    function setActiveSection(sectionId) {
      const sections = document.querySelectorAll('.round-section');
      sections.forEach(section => {
        section.classList.remove('active');
        section.classList.add('inactive');
      });
      
      const activeSection = document.getElementById(sectionId);
      if (activeSection) {
        activeSection.classList.remove('inactive');
        activeSection.classList.add('active');
      }
    }

    function calculateMaxScore(multiplier) {
      // Perfect hit (0° error) gives 90 points, multiplied by speed multiplier
      return Math.round(90 * multiplier);
    }

    function calculateMinScore(multiplier) {
      // Worst case (180° error) gives -90 points, multiplied by speed multiplier
      return Math.round(-90 * multiplier);
    }

    function showSpeedConfig(callback) {
      const initialMultiplier = speedMultiplier;
      let currentMultiplier = initialMultiplier;
      let previewInterval;
      let previewAngle = 0;
      let previewStartTime = 0;

      const speedContent = document.getElementById("speed-config-content");
      speedContent.innerHTML = `
          <div style="margin-top: 10px;">
            <p style="text-align: center; margin: 6px 0 10px 0; color: rgba(255,255,255,0.85); font-size: 13px;">Score after this round</p>
            <div style="display: flex; gap: 12px; align-items: stretch; justify-content: center;">
              <p id="after-round-max" style="flex: 1; margin: 0; font-size: 18px; color: #00ff9d; font-weight: 800; background: rgba(0,255,157,0.1); border: 2px solid rgba(0,255,157,0.35); border-radius: 10px; padding: 10px 12px; text-align: center;">Max: <span style="font-weight: 900;">${score + calculateMaxScore(currentMultiplier)}</span></p>
              <p id="after-round-min" style="flex: 1; margin: 0; font-size: 18px; color: #ff7a7a; font-weight: 800; background: rgba(255,0,0,0.06); border: 2px solid rgba(255,102,102,0.35); border-radius: 10px; padding: 10px 12px; text-align: center;">Min: <span style="font-weight: 900;">${score + calculateMinScore(currentMultiplier)}</span></p>
            </div>
          </div>
        </div>
        <div style="margin: 15px 0;">
          <p style="text-align: center; margin-bottom: 10px; color: #00ffff; font-size: 13px;">Speed Preview</p>
          <div class="arrow-container" style="margin: 0 auto; width: 150px; height: 150px;">
            <div id="preview-ghost-arrow"></div>
            <div id="preview-arrow"></div>
          </div>
          <p id="preview-speed-info" style="text-align: center; font-size: 11px; color: rgba(0, 255, 255, 0.7); margin-top: 10px;">${(120 * currentMultiplier).toFixed(0)} deg/sec</p>
        </div>
        <div id="speed-value" style="font-size: 20px;">${currentMultiplier.toFixed(1)}x</div>
        <input type="range" id="speed-slider" min="3" max="10" step="0.1" value="${initialMultiplier}" style="margin: 10px 0;">
        <div id="speed-info" style="font-size: 12px;">
          <p>3x (slow) ~ 10x (very fast)</p>
          <p style="font-size: 11px; color: rgba(255, 255, 255, 0.6); margin-top: 5px;">Higher speed yields more points</p>
        </div>
        <button id="confirm-speed-btn" style="margin-top: 15px; padding: 10px 20px; font-size: 14px;">Confirm</button>
      `;

      const previewArrow = document.getElementById("preview-arrow");
      const previewGhost = document.getElementById("preview-ghost-arrow");
      const previewSpeedInfo = document.getElementById("preview-speed-info");
      const slider = document.getElementById("speed-slider");
      const speedValue = document.getElementById("speed-value");
      const afterRoundMaxEl = document.getElementById("after-round-max");
      const afterRoundMinEl = document.getElementById("after-round-min");
      const confirmBtn = document.getElementById("confirm-speed-btn");

      // Set preview arrow styles (smaller for preview)
      const arrowHeight = 60;
      const arrowWidth = 8;
      previewGhost.style.width = "0";
      previewGhost.style.height = "0";
      previewGhost.style.borderLeft = `${arrowWidth}px solid transparent`;
      previewGhost.style.borderRight = `${arrowWidth}px solid transparent`;
      previewGhost.style.borderBottom = `${arrowHeight}px solid rgba(255,255,255,0.25)`;
      previewGhost.style.transformOrigin = `${arrowWidth}px ${arrowHeight}px`;
      previewGhost.style.position = "absolute";
      previewGhost.style.top = `calc(50% - ${arrowHeight}px)`;
      previewGhost.style.left = `calc(50% - ${arrowWidth}px)`;
      previewGhost.style.filter = "drop-shadow(0 0 4px rgba(255, 255, 255, 0.3))";

      previewArrow.style.width = "0";
      previewArrow.style.height = "0";
      previewArrow.style.borderLeft = `${arrowWidth}px solid transparent`;
      previewArrow.style.borderRight = `${arrowWidth}px solid transparent`;
      previewArrow.style.borderBottom = `${arrowHeight}px solid #00ffff`;
      previewArrow.style.transformOrigin = `${arrowWidth}px ${arrowHeight}px`;
      previewArrow.style.position = "absolute";
      previewArrow.style.top = `calc(50% - ${arrowHeight}px)`;
      previewArrow.style.left = `calc(50% - ${arrowWidth}px)`;
      previewArrow.style.filter = "drop-shadow(0 0 8px rgba(0, 255, 255, 0.8))";

      // Initialize preview
      previewGhost.style.transform = `rotate(0deg)`;
      previewAngle = 0;
      previewStartTime = performance.now();

      function updatePreview() {
        const currentSpeed = 120 * currentMultiplier;
        const delta = (performance.now() - previewStartTime) / 1000;
        previewAngle = (delta * currentSpeed) % 360;
        previewArrow.style.transform = `rotate(${previewAngle}deg)`;
        previewSpeedInfo.textContent = `${currentSpeed.toFixed(0)} deg/sec`;
      }

      function startPreview() {
        updatePreview();
        previewInterval = requestAnimationFrame(function animate() {
          updatePreview();
          previewInterval = requestAnimationFrame(animate);
        });
      }

      startPreview();

      slider.oninput = () => {
        currentMultiplier = parseFloat(slider.value);
        speedValue.textContent = currentMultiplier.toFixed(1) + "x";
        const maxScore = calculateMaxScore(currentMultiplier);
        const minScore = calculateMinScore(currentMultiplier);
        if (afterRoundMaxEl) afterRoundMaxEl.innerHTML = `Max: <span style=\"font-weight: 900;\">${score + maxScore}</span>`;
        if (afterRoundMinEl) afterRoundMinEl.innerHTML = `Min: <span style=\"font-weight: 900;\">${score + minScore}</span>`;
        previewStartTime = performance.now();
        updatePreview();
      };

      confirmBtn.onclick = () => {
        if (previewInterval) cancelAnimationFrame(previewInterval);
        speedMultiplier = currentMultiplier;
        rotationSpeed = 120 * speedMultiplier; // Base speed * multiplier
        callback();
      };
    }

    function startRound() {
      const gameContent = document.getElementById("game-content");
      gameContent.innerHTML = `
        <div style="margin-bottom: 10px;">
          <p style="margin: 5px 0; font-size: 14px;">Round ${round}/5</p>
          <p style="margin: 5px 0; font-size: 12px; color: #00ffff;">Speed: ${rotationSpeed.toFixed(0)} deg/sec (${speedMultiplier.toFixed(1)}x)</p>
          <p style="margin: 5px 0; font-size: 11px; color: rgba(0, 255, 255, 0.7);">Max possible: ${calculateMaxScore(speedMultiplier)} pts</p>
        </div>
        <div class="arrow-container" style="margin: 15px auto; width: 150px; height: 150px;">
          <div id="ghost-arrow"></div>
          <div id="arrow"></div>
        </div>
        <button id="stop-btn" disabled style="margin-top: 15px; padding: 10px 20px; font-size: 14px;">Stop</button>
      `;

      // Clear result section
      document.getElementById("result-content").innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; margin-top: 50px;">Start the game</p>';

      // Set active section
      setActiveSection("game-section");

      const arrow = document.getElementById("arrow");
      const ghost = document.getElementById("ghost-arrow");
      const stopBtn = document.getElementById("stop-btn");

      // Set arrow styles (smaller for game section)
      const arrowHeight = 60;
      const arrowWidth = 8;
      ghost.style.width = "0";
      ghost.style.height = "0";
      ghost.style.borderLeft = `${arrowWidth}px solid transparent`;
      ghost.style.borderRight = `${arrowWidth}px solid transparent`;
      ghost.style.borderBottom = `${arrowHeight}px solid rgba(255,255,255,0.25)`;
      ghost.style.transformOrigin = `${arrowWidth}px ${arrowHeight}px`;
      ghost.style.position = "absolute";
      ghost.style.top = `calc(50% - ${arrowHeight}px)`;
      ghost.style.left = `calc(50% - ${arrowWidth}px)`;
      ghost.style.filter = "drop-shadow(0 0 4px rgba(255, 255, 255, 0.3))";

      arrow.style.width = "0";
      arrow.style.height = "0";
      arrow.style.borderLeft = `${arrowWidth}px solid transparent`;
      arrow.style.borderRight = `${arrowWidth}px solid transparent`;
      arrow.style.borderBottom = `${arrowHeight}px solid #00ffff`;
      arrow.style.transformOrigin = `${arrowWidth}px ${arrowHeight}px`;
      arrow.style.position = "absolute";
      arrow.style.top = `calc(50% - ${arrowHeight}px)`;
      arrow.style.left = `calc(50% - ${arrowWidth}px)`;
      arrow.style.filter = "drop-shadow(0 0 8px rgba(0, 255, 255, 0.8))";

      startAngle = Math.random() * 360;
      ghost.style.transform = `rotate(${startAngle}deg)`;

      isRunning = false;

      setTimeout(() => {
        // start rotation after showing startAngle briefly
        isRunning = true;
        startTime = performance.now();

        // Disable stop button for 3 seconds with countdown
        stopBtn.disabled = true;
        let remaining = 3;
        stopBtn.textContent = `Stop (${remaining})`;
        const countdownInterval = setInterval(() => {
          remaining -= 1;
          if (remaining > 0) {
            stopBtn.textContent = `Stop (${remaining})`;
          }
        }, 1000);

        setTimeout(() => {
          clearInterval(countdownInterval);
          stopBtn.disabled = false;
          stopBtn.textContent = 'Stop';
        }, 3000);
      }, 1000);

      interval = requestAnimationFrame(function rotateArrow(ts) {
        if (!isRunning) return requestAnimationFrame(rotateArrow);
        const delta = (ts - startTime) / 1000;
        currentAngle = (startAngle + delta * rotationSpeed) % 360;
        arrow.style.transform = `rotate(${currentAngle}deg)`;
        if (delta < 15) {
          requestAnimationFrame(rotateArrow);
        } else {
          score -= Math.round(90 * speedMultiplier);
          updateHUD();
          nextRound();
        }
      });

      stopBtn.onclick = () => {
        if (!isRunning) return;
        isRunning = false;
        const diff = Math.abs(currentAngle - startAngle);
        const error = diff > 180 ? 360 - diff : diff;
        let roundScore = 0;
        if (error <= 90) roundScore = (90 - error) * speedMultiplier;
        else roundScore = -(error - 90) * speedMultiplier;
        score += Math.round(roundScore);
        updateHUD();

        // Show result in result section
        const arrowHeight = 60;
        const arrowWidth = 8;
        const resultContent = document.getElementById("result-content");
        resultContent.innerHTML = `
          <div style="margin: 10px 0;">
            <div class="arrow-container" style="margin: 0 auto; width: 120px; height: 120px;">
              <div style="
                width: 0;
                height: 0;
                border-left: ${arrowWidth}px solid transparent;
                border-right: ${arrowWidth}px solid transparent;
                border-bottom: ${arrowHeight}px solid rgba(255,255,255,0.25);
                transform-origin: ${arrowWidth}px ${arrowHeight}px;
                position: absolute;
                top: calc(50% - ${arrowHeight}px);
                left: calc(50% - ${arrowWidth}px);
                filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.3));
                transform: rotate(${startAngle}deg);
              "></div>
              <div style="
                width: 0;
                height: 0;
                border-left: ${arrowWidth}px solid transparent;
                border-right: ${arrowWidth}px solid transparent;
                border-bottom: ${arrowHeight}px solid #00ffff;
                transform-origin: ${arrowWidth}px ${arrowHeight}px;
                position: absolute;
                top: calc(50% - ${arrowHeight}px);
                left: calc(50% - ${arrowWidth}px);
                filter: drop-shadow(0 0 8px rgba(0, 255, 255, 0.8));
                transform: rotate(${currentAngle}deg);
              "></div>
            </div>
          </div>
          <div style="margin-top: 15px; font-size: 13px;">
            <p style="margin: 8px 0;">Target Angle: <span style="color: #00ffff; font-weight: bold;">${Math.round(startAngle)}°</span></p>
            <p style="margin: 8px 0;">Chosen Angle: <span style="color: #00ffff; font-weight: bold;">${Math.round(currentAngle)}°</span></p>
            <p style="margin: 8px 0;">Angle Error: <span style="color: #00ffff; font-weight: bold;">${Math.round(error)}°</span></p>
            <p style="margin: 12px 0; font-size: 16px; color: ${roundScore >= 0 ? '#00ff00' : '#ff0000'};">
              Round Score: <span style="font-weight: bold;">${roundScore >= 0 ? '+' : ''}${Math.round(roundScore)}</span>
            </p>
            <p style="margin: 12px 0 5px 0; font-size: 14px;">Total Score: <span style="color: #00ffff; font-weight: bold;">${score}</span></p>
          </div>
          <button id="continue-btn" style="margin-top: 15px; padding: 10px 20px; font-size: 14px;">Next Round</button>
        `;

        // Set active section
        setActiveSection("result-section");

        document.getElementById("continue-btn").onclick = nextRound;
      };
    }

    function nextRound() {
      round++;
      if (round > 5) return endGame();

      // Show speed configuration before each round
      updateHUD();
      setActiveSection("speed-config-section");
      showSpeedConfig(startRound);
    }

    function endGame() {
      gameArea.innerHTML = `
        <h2>Game Over!</h2>
        <p>Final Score: ${score}</p>
        <button id="retry-btn">Retry</button>
      `;
      document.getElementById("retry-btn").onclick = startGame;
    }

    document.getElementById("start-btn").onclick = startGame;
  </script>
</body>
</html>
