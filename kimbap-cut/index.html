<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Kimbap Cutter</title>
  <style>
    :root { --text:#1b2450; --muted:#6c7aa8; --accent:#6df0c2; --danger:#ff6a85; }
    *{ box-sizing:border-box }
    html, body { height:100%; width:100%; }
    body {
      margin:0;
      background: linear-gradient(180deg, #f7fbff, #f2f7ff);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial;
      display:flex; align-items:center; justify-content:center; min-height:100vh;
    }

    .game {
      width: min(520px, 92vw);
      aspect-ratio: 9 / 16;
      background: linear-gradient(180deg, #f8fbff 0%, #f4f9ff 100%);
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.6);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    .game::before { /* pastel tiles (top area) */
      content: ""; position: absolute; inset: 0 0 40% 0; z-index: 0;
      background-color: #fbfeff;
      background-image:
        linear-gradient(90deg, rgba(198,220,255,0.5) 1px, transparent 1px),
        linear-gradient(180deg, rgba(198,220,255,0.5) 1px, transparent 1px),
        radial-gradient(600px 200px at 70% -20%, rgba(255,182,193,0.12), transparent 60%),
        radial-gradient(400px 160px at 10% 20%, rgba(173,216,230,0.12), transparent 60%);
      background-size: 28px 28px, 28px 28px, auto, auto;
      box-shadow: inset 0 -8px 12px rgba(0,0,0,0.05);
    }
    .game::after { /* bottom area: leave transparent */
      content: ""; position: absolute; inset: 60% 0 0 0; z-index: 0; background: transparent;
    }

    .topbar {
      position: absolute; inset: 0 0 auto 0; height: 72px; display: flex; align-items: center; justify-content: space-between; padding: 16px 18px; gap: 8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.0));
    }
    .title { font-weight: 800; letter-spacing: 0.3px; color:#2a3655; }
    .sub { font-size: 12px; color: var(--muted); }

    .hud { display: flex; align-items: center; gap: 12px; }
    .pill { background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.08); border-radius: 999px; padding: 8px 12px; display: flex; align-items: center; gap: 10px; font-size: 13px; }
    .dots { display: grid; grid-auto-flow: column; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(0,0,0,0.1); }
    .dot.done { background: var(--accent); box-shadow: 0 0 8px rgba(109,240,194,0.6); }
    .iconbtn { background: rgba(255,255,255,0.7); border: 1px solid rgba(0,0,0,0.08); color: #2a3655; border-radius: 999px; padding: 8px 12px; font-size: 13px; cursor: pointer; }

    .board {
      position: absolute; inset: 84px 16px 120px 16px; border-radius: 14px; overflow: hidden;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.06);
      display: grid; place-items: center;
    }
    .plate {
      position: absolute; left: 50%; top: 56%; transform: translate(-50%, -50%);
      width: 86%; aspect-ratio: 1 / 1; border-radius: 50%;
      background: radial-gradient(closest-side, #ffffff 0%, #f8fbff 70%, #eef5ff 100%);
      box-shadow: 0 10px 30px rgba(0,0,0,0.15), inset 0 0 0 10px rgba(255,255,255,0.9), inset 0 0 0 14px rgba(0,0,0,0.06);
      z-index: 0;
    }
    .plate-overlay { position: absolute; left: 50%; top: 56%; transform: translate(-50%, -50%); width: 86%; aspect-ratio: 1/1; border-radius: 50%; pointer-events: none; z-index: 0; }
    .plate-overlay .pieces { position: absolute; inset: 8% 8%; }
    .piece { position: absolute; width: 80px; aspect-ratio: 1/1; transform: translate(-50%,-50%) scale(0.8); filter: drop-shadow(0 6px 10px rgba(0,0,0,0.25)); animation: pieceIn 260ms cubic-bezier(.2,.9,.3,1); }
    @keyframes pieceIn { from { transform: translate(-50%,-50%) scale(0.4); opacity: 0; } to { transform: translate(-50%,-50%) scale(0.8); opacity: 1; } }
    .mini-endcap { position: relative; width: 100%; height: 100%; border-radius: 50%; background: #0f0f12; box-shadow: inset 0 0 0 5px #0b0b0d; display: grid; place-items: center; }
    .mini-endcap .rice { position: relative; width: 84%; height: 84%; border-radius: 50%; background: radial-gradient(closest-side, #ffffff, #eef3ff 70%); box-shadow: inset 0 0 0 6px #0b0b0d; }
    .mini-fill { position: absolute; inset: 16% 16%; }
    .mini { position: absolute; border-radius: 50%; }
    .mini.spinach { background:#2fb067; width:22%; height:22%; left:20%; top:24%; border-radius: 50% 40% 40% 50%/60% 40% 60% 40%; }
    .mini.egg { background:#ffd966; width:30%; height:26%; left:26%; top:46%; border-radius:6px; }
    .mini.radish { background:#f3b500; width:22%; height:22%; left:42%; top:64%; border-radius:5px; }
    .mini.burdock { background:#6a412c; width:28%; height:16%; left:46%; top:26%; border-radius:5px; }
    .mini.crab { background:#ff6b6b; width:26%; height:26%; right:18%; top:42%; border-radius:6px; }

    /* Knife (visible above roll) */
    .knife { position: absolute; left: 50%; top: 12%; transform: translateX(-50%); width: 66%; height: 54px; display: grid; grid-template-columns: 3fr 1fr; align-items: stretch; filter: drop-shadow(0 10px 18px rgba(0,0,0,0.35)); will-change: transform; z-index: 3; pointer-events: none; }
    .blade { background: linear-gradient(180deg, #eef4ff, #a9bad3); border-radius: 10px 0 0 10px; border: 1px solid #92a6c5; position: relative; overflow: hidden; }
    .blade::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent 0 50%, rgba(255,255,255,0.56) 52%, transparent 55%); mix-blend-mode: overlay; }
    .handle { background: linear-gradient(180deg, #6a5647, #3b2e26); border-radius: 0 10px 10px 0; border: 1px solid #2b201a; }

    /* Kimbap roll */
    .roll { position: relative; width: 76%; max-width: 420px; aspect-ratio: 7 / 3; background: radial-gradient(150% 130% at 70% 30%, #0d0d10 0%, #0a0a0d 55%, #050508 100%); border-radius: 999px; border: 2px solid rgba(255,255,255,0.04); box-shadow: inset 0 0 28px rgba(255,255,255,0.05), 0 24px 40px rgba(0,0,0,0.45); z-index: 1; }
    .roll::before { content: ""; position: absolute; inset: 0; border-radius: inherit; pointer-events: none; background: linear-gradient(110deg, transparent 0 55%, rgba(255,255,255,0.05) 56%, rgba(255,255,255,0.18) 57%, rgba(255,255,255,0.05) 60%, transparent 61% 100%); mix-blend-mode: screen; }
    .roll::after { content: ""; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 66%; height: 66%; border-radius: 50%; background: radial-gradient(closest-side, rgba(0,0,0,0.18), rgba(0,0,0,0.0) 70%); filter: blur(6px); opacity: 0.6; }

    /* Endcap cross-section */
    .endcap { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 64%; aspect-ratio: 1 / 1; border-radius: 50%; background: #0f0f12; box-shadow: inset 0 0 0 6px #0b0b0d, 0 6px 10px rgba(0,0,0,0.35); display: grid; place-items: center; }
    .endcap .rice {
      position: relative; width: 88%; aspect-ratio: 1 / 1; border-radius: 50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,0.95), rgba(240,244,255,0.95) 60%, rgba(230,235,248,0.9) 80%),
        radial-gradient(3px 3px at 30% 28%, rgba(0,0,0,0.06), transparent 70%),
        radial-gradient(3px 3px at 60% 45%, rgba(0,0,0,0.06), transparent 70%),
        radial-gradient(3px 3px at 45% 70%, rgba(0,0,0,0.05), transparent 70%),
        radial-gradient(2px 2px at 70% 25%, rgba(0,0,0,0.05), transparent 70%),
        radial-gradient(2px 2px at 25% 60%, rgba(0,0,0,0.05), transparent 70%);
      box-shadow: inset 0 0 0 8px #0b0b0d;
      filter: saturate(1.02);
      display: grid; place-items: center;
    }
    .fillings { position: absolute; inset: 14% 14%; }
    .ing { position: absolute; border-radius: 6px; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.12); }
    .ing.egg { background: linear-gradient(180deg, #ffe27a, #ffcf4a); width: 32%; height: 28%; left: 12%; top: 36%; transform: rotate(-8deg); }
    .ing.radish { background: linear-gradient(180deg, #ffd84a, #f3b500); width: 22%; height: 26%; left: 34%; bottom: 10%; transform: rotate(6deg); }
    .ing.crab { background: linear-gradient(180deg, #ff6b6b, #d94c4c); width: 26%; height: 30%; right: 16%; top: 34%; border-radius: 6px; }
    .ing.burdock { background: linear-gradient(180deg, #8a5b3e, #6a412c); width: 26%; height: 18%; left: 40%; top: 18%; border-radius: 5px; }
    .ing.spinach { background: linear-gradient(180deg, #2fb067, #1e8a4f); width: 20%; height: 22%; left: 16%; top: 18%; border-radius: 50% 40% 40% 50% / 60% 40% 60% 40%; }

    /* Burst crack overlay */
    .crack { position: absolute; inset: 0; pointer-events: none; opacity: 0; transition: opacity 200ms ease; }
    .crack.show { opacity: 1; }
    .crack svg { width: 100%; height: 100%; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }

    /* Bottom controls */
    .bottombar { position: absolute; inset: auto 0 0 0; padding: 14px 16px 16px; display: grid; gap: 8px; background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.08)); }
    .btn { -webkit-tap-highlight-color: transparent; appearance: none; border: 0; outline: 0; cursor: pointer; background: linear-gradient(180deg, #6df0c2, #3fd39f); color: #0b1320; font-weight: 800; letter-spacing: 0.4px; border-radius: 12px; padding: 14px 18px; font-size: 16px; box-shadow: 0 12px 20px rgba(109,240,194,0.25), inset 0 1px 0 rgba(255,255,255,0.5); transition: transform 90ms ease, box-shadow 120ms ease; }
    .btn:active { transform: translateY(1px); box-shadow: 0 8px 14px rgba(109,240,194,0.22), inset 0 1px 0 rgba(255,255,255,0.6); }

    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .row .btn.secondary { background: linear-gradient(180deg, #d8e0f2, #b6c4de); }
    .btn[disabled] { opacity: 0.6; cursor: not-allowed; }

    .msg { text-align: center; font-weight: 700; letter-spacing: 0.4px; color:#2a3655; }
    .hint { font-size: 12px; color: var(--muted); text-align: center; }
    .yt-holder { position: absolute; width: 1px; height: 1px; left: -9999px; top: -9999px; pointer-events: none; }

    /* Overlays */
    .overlay { position: absolute; inset: 0; display: grid; place-items: center; z-index: 2; pointer-events: none; }
    .overlay .panel { background: rgba(255,255,255,0.82); backdrop-filter: blur(6px); border: 1px solid rgba(0,0,0,0.08); border-radius: 16px; padding: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); width: min(80%, 360px); pointer-events: all; }
    .start-btn { appearance: none; border: 0; outline: 0; cursor: pointer; border-radius: 12px; padding: 14px 20px; font-weight: 800; letter-spacing: 0.4px; font-size: 18px; background: linear-gradient(180deg, #fff7b8, #ffe47a); color: #3b2f00; box-shadow: 0 10px 18px rgba(255,228,122,0.35), inset 0 1px 0 rgba(255,255,255,0.9); transition: transform 120ms ease, box-shadow 150ms ease; }
    .start-btn:hover { transform: scale(1.03); box-shadow: 0 14px 22px rgba(255,228,122,0.4), inset 0 1px 0 rgba(255,255,255,1); }
    .start-btn:active { transform: scale(0.99); }
    .retry-btn { appearance: none; border: 0; outline: 0; cursor: pointer; border-radius: 12px; padding: 12px 18px; font-weight: 800; letter-spacing: 0.4px; font-size: 16px; background: linear-gradient(180deg, #bfe0ff, #8ec5ff); color: #0a2540; box-shadow: 0 10px 18px rgba(142,197,255,0.35), inset 0 1px 0 rgba(255,255,255,0.9); transition: transform 120ms ease, box-shadow 150ms ease; }
    .retry-btn:hover { transform: scale(1.03); box-shadow: 0 14px 22px rgba(142,197,255,0.4), inset 0 1px 0 rgba(255,255,255,1); }
    .retry-btn:active { transform: scale(0.99); }
    .hidden { display: none !important; }

    /* Animations */
    .shake { animation: shake 300ms ease-in-out; }
    @keyframes shake { 0% { transform: translateX(-1px) rotate(0.2deg); } 20% { transform: translateX(2px) rotate(-0.4deg); } 40% { transform: translateX(-2px) rotate(0.3deg); } 60% { transform: translateX(2px) rotate(-0.2deg); } 80% { transform: translateX(-1px) rotate(0.1deg); } 100% { transform: translateX(0) rotate(0); } }
    .slice { animation: slice 240ms cubic-bezier(.2,.9,.3,1.2); transform-origin: 50% 120%; }
    @keyframes slice { 0% { transform: translateX(-50%) rotate(0deg); } 60% { transform: translateX(-50%) translateY(160px) rotate(12deg); } 100% { transform: translateX(-50%) translateY(0) rotate(0); } }

    /* Explosion */
    .explosion { position: absolute; inset: 0; pointer-events: none; overflow: visible; }
    .particle { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); opacity: 1; animation: pop 650ms cubic-bezier(.15,.8,.2,1) forwards; }
    .particle.rice { width: 6px; height: 6px; background: #fff; border-radius: 50%; box-shadow: 0 0 0 1px rgba(0,0,0,0.06) inset; }
    .particle.nori { width: 12px; height: 4px; background: #0b0b0d; border-radius: 2px; }
    .particle.egg { width: 10px; height: 6px; background: #ffd966; border-radius: 3px; }
    .particle.radish { width: 9px; height: 6px; background: #f3b500; border-radius: 3px; }
    .particle.crab { width: 9px; height: 7px; background: #ff6b6b; }
    .particle.spinach { width: 8px; height: 6px; background: #2fb067; }
    .particle.burdock { width: 10px; height: 5px; background: #6a412c; }
    @keyframes pop { 0% { transform: translate(-50%, -50%) translate(0,0) rotate(0deg); opacity: 1; } 100% { transform: translate(-50%, -50%) translate(var(--dx), var(--dy)) rotate(var(--rot)); opacity: 0; } }
    .flash { position: absolute; inset: 0; background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.8), rgba(255,255,255,0) 60%); opacity: 0; pointer-events: none; transition: opacity 160ms ease; }
    .flash.show { opacity: 1; }

    .lose { color: var(--danger); }
    .win { color: var(--accent); }
  </style>
</head>
<body>
  <div class="game" id="game">
    <div class="topbar">
      <div>
        <div class="title">Kimbap Cutter</div>
        <div class="sub">Make 10 cuts. If it bursts even once, you lose.</div>
      </div>
      <div class="hud">
        <div class="pill"><span id="cutsLabel">Cuts</span><div class="dots" id="dots"></div></div>
        <div class="pill" title="Burst chance">💥 <span id="chance">--%</span></div>
        <button class="iconbtn" id="musicBtn" title="Toggle music">🔊 BGM</button>
      </div>
    </div>

    <div class="overlay" id="startOverlay">
      <div class="panel">
        <div style="font-weight:800; margin-bottom:10px; color:#2a3655;">Kimbap Cutter</div>
        <div style="font-size:13px; color:#586a92; margin-bottom:16px;">Make 10 cuts without bursting the roll.</div>
        <button id="startBtn" class="start-btn" aria-label="Start Game">Start Game</button>
      </div>
    </div>

    <div class="overlay hidden" id="gameOver">
      <div class="panel">
        <div id="goTitle" style="font-weight:800; margin-bottom:10px; color:#2a3655;">Game Over</div>
        <div id="goMsg" style="font-size:13px; color:#586a92; margin-bottom:16px;">Try again and beat your luck!</div>
        <button id="retryBtn" class="retry-btn" aria-label="Retry">Retry</button>
      </div>
    </div>

    <div class="board">
      <div class="knife" id="knife"><div class="blade"></div><div class="handle"></div></div>
      <div class="plate"></div>
      <div class="plate-overlay"><div class="pieces" id="pieces"></div></div>
      <div class="roll" id="roll">
        <div class="explosion" id="explosion"></div>
        <div class="endcap">
          <div class="rice">
            <div class="fillings">
              <span class="ing spinach"></span>
              <span class="ing egg"></span>
              <span class="ing radish"></span>
              <span class="ing burdock"></span>
              <span class="ing crab"></span>
            </div>
          </div>
        </div>
        <div class="crack" id="crack">
          <svg viewBox="0 0 100 40" preserveAspectRatio="none">
            <polyline points="0,20 10,18 16,22 25,19 33,24 42,20 50,26 60,18 68,23 78,19 86,22 95,18 100,20" fill="none" stroke="rgba(255,106,133,0.9)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
      <div class="flash" id="flash"></div>
    </div>

    <div class="bottombar">
      <div class="msg" id="msg">Tap Start Game to begin!</div>
      <div class="row">
        <button class="btn" id="cutBtn" aria-label="Cut">✂️ Cut</button>
        <button class="btn secondary" id="resetBtn" aria-label="Restart">Restart</button>
      </div>
      <div class="hint">Tip: Burst chance slightly increases with each cut. Good luck!</div>
    </div>
  </div>
  <div id="yt-holder" class="yt-holder"></div>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
  (function(){
    const dotsEl = document.getElementById('dots');
    const chanceEl = document.getElementById('chance');
    const msgEl = document.getElementById('msg');
    const cutBtn = document.getElementById('cutBtn');
    const resetBtn = document.getElementById('resetBtn');
    const knife = document.getElementById('knife');
    const roll = document.getElementById('roll');
    const crack = document.getElementById('crack');
    const cutsLabel = document.getElementById('cutsLabel');
    const piecesEl = document.getElementById('pieces');
    const musicBtn = document.getElementById('musicBtn');
    const startBtn = document.getElementById('startBtn');
    const gameOver = document.getElementById('gameOver');
    const retryBtn = document.getElementById('retryBtn');
    const goTitle = document.getElementById('goTitle');
    const goMsg = document.getElementById('goMsg');

    const MAX_CUTS = 10;

    let state = {
      cuts: 0,
      done: false,
      burst: false,
      started: false,
      extraLifeUsed: false,
      baseChance: 0.10,
      perCutRamp: 0.035,
    };

    // YouTube IFrame Player API integration
    const VIDEO_ID = 'a7b2HAttS8s';
    let ytPlayer = null; let ytReady = false; let startRequested = false; let musicOn = true;
    window.onYouTubeIframeAPIReady = function() {
      ytPlayer = new YT.Player('yt-holder', {
        height: '1', width: '1', videoId: VIDEO_ID,
        playerVars: { autoplay: 0, controls: 0, modestbranding: 1, loop: 1, playlist: VIDEO_ID, playsinline: 1, rel: 0 },
        events: { onReady: function() { ytReady = true; ytPlayer.setVolume(80); if (startRequested && musicOn) playBgmWithFallback(); } }
      });
    };
    function playBgmWithFallback(){ try{ ytPlayer.unMute(); const p = ytPlayer.playVideo(); if(p && p.catch) p.catch(()=>{ ytPlayer.mute(); ytPlayer.playVideo(); }); } catch{}
    }
    function startMusic(){ startRequested = true; if (ytReady && ytPlayer) { if (musicOn) playBgmWithFallback(); } }
    function toggleMusic(){ if (!ytPlayer) { startMusic(); return; } const muted = ytPlayer.isMuted(); if (muted) { ytPlayer.unMute(); musicOn = true; musicBtn.textContent = '🔊 BGM'; } else { ytPlayer.mute(); musicOn = false; musicBtn.textContent = '🔈 BGM'; } }

    function currentBurstChance(){ const c = state.baseChance + state.perCutRamp * state.cuts; return Math.min(0.65, Math.max(0, c)); }
    function fmtPct(p){ return Math.round(p * 100); }
    function renderDots(){ dotsEl.innerHTML = ''; for(let i=0;i<MAX_CUTS;i++){ const d=document.createElement('div'); d.className='dot'+(i<state.cuts?' done':''); dotsEl.appendChild(d);} cutsLabel.textContent = `Cuts ${state.cuts}/${MAX_CUTS}`; }

    // Plate positions: ensure all slices are visible in lower half (two rows)
    const pieceSpots = [
      // lower band (row 1)
      {x:18,y:78,s:.76}, {x:30,y:82,s:.78}, {x:42,y:84,s:.80}, {x:58,y:84,s:.80}, {x:70,y:82,s:.78},
      // lower-mid band (row 2)
      {x:22,y:66,s:.76}, {x:34,y:70,s:.78}, {x:46,y:72,s:.80}, {x:58,y:70,s:.78}, {x:70,y:66,s:.76},
    ];

    function placePiece(index){
      if (!piecesEl) return;
      const spot = pieceSpots[index % pieceSpots.length];
      const wrap = document.createElement('div');
      wrap.className = 'piece';
      wrap.style.left = spot.x + '%';
      wrap.style.top = spot.y + '%';
      wrap.style.transform = `translate(-50%, -50%) scale(${spot.s}) rotate(${(Math.random()*20-10).toFixed(1)}deg)`;
      wrap.innerHTML = '<div class="mini-endcap"><div class="rice"><div class="mini-fill"><span class="mini spinach"></span><span class="mini egg"></span><span class="mini radish"></span><span class="mini burdock"></span><span class="mini crab"></span></div></div></div>';
      piecesEl.appendChild(wrap);
    }

    function updateHUD(){ chanceEl.textContent = fmtPct(currentBurstChance()) + '%'; }
    function setMessage(text, cls){ msgEl.classList.remove('lose','win'); if (cls) msgEl.classList.add(cls); msgEl.textContent = text; }
    function screenShake(){ roll.classList.remove('shake'); void roll.offsetWidth; roll.classList.add('shake'); }
    function animateKnife(){ knife.classList.remove('slice'); void knife.offsetWidth; knife.classList.add('slice'); }

    function burstEffect(){
      crack.classList.add('show');
      screenShake();
      document.body.style.transition = 'background 120ms ease';
      const prev = document.body.style.background;
      document.body.style.background = 'radial-gradient(900px 600px at 50% -10%, #35171f 0%, #0f1220 60%, #0b0e1b 100%)';
      setTimeout(()=>{ document.body.style.background = prev; }, 120);
      explode();
    }

    function simpleBeep(hz=320,ms=120,type='square',vol=0.04){
      try {
        const ctx = simpleBeep.ctx || (simpleBeep.ctx = new (window.AudioContext || window.webkitAudioContext)());
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = type; o.frequency.value = hz;
        g.gain.value = vol; o.connect(g); g.connect(ctx.destination);
        o.start(); g.gain.setTargetAtTime(0, ctx.currentTime + ms/1000, 0.02);
        setTimeout(()=>{ o.stop(); o.disconnect(); g.disconnect(); }, ms+80);
      } catch{}
    }
    function failBeep(){ simpleBeep(180,240,'sawtooth',0.06); }
    function sliceSfx(){
      try{
        const ctx = sliceSfx.ctx || (sliceSfx.ctx = new (window.AudioContext || window.webkitAudioContext)());
        const now = ctx.currentTime;
        const bufferSize = 0.08 * ctx.sampleRate;
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for (let i=0;i<bufferSize;i++){ data[i] = (Math.random()*2-1) * (1 - i/bufferSize); }
        const noise = ctx.createBufferSource(); noise.buffer = buffer;
        const nGain = ctx.createGain(); nGain.gain.value = 0.16;
        const hp = ctx.createBiquadFilter(); hp.type = 'highpass'; hp.frequency.value = 1200;
        noise.connect(hp); hp.connect(nGain); nGain.connect(ctx.destination);
        nGain.gain.setValueAtTime(0.18, now);
        nGain.gain.exponentialRampToValueAtTime(0.003, now + 0.08);
        noise.start(now); noise.stop(now + 0.09);
        const osc = ctx.createOscillator(); osc.type = 'triangle'; osc.frequency.setValueAtTime(1400, now);
        const oGain = ctx.createGain(); oGain.gain.value = 0.09; osc.connect(oGain); oGain.connect(ctx.destination);
        oGain.gain.setValueAtTime(0.12, now);
        oGain.gain.exponentialRampToValueAtTime(0.002, now + 0.06);
        osc.start(now); osc.stop(now + 0.08);
      } catch{}
    }
    function passBeep(){ sliceSfx(); }
    function winJingle(){ simpleBeep(660,120,'triangle',0.06); setTimeout(()=>simpleBeep(880,140,'square',0.06),130); }

    function showGameOver(win=false){
      if (win) { goTitle.textContent = 'You Win!'; goMsg.textContent = 'Perfect 10 cuts. Want to play again?'; }
      else { goTitle.textContent = 'Game Over'; goMsg.textContent = 'The roll burst! Try your luck again.'; }
      gameOver.classList.remove('hidden');
    }

    function doCut(){
      if (!state.started){ setMessage('Press Start Game first.'); return; }
      if (state.done) return;
      animateKnife();
      setTimeout(()=>{
        const chance = currentBurstChance();
        const r = Math.random();
        if (r < chance) {
          burstEffect(); failBeep();
          if (!state.extraLifeUsed) {
            state.extraLifeUsed = true;
            setMessage('It burst! One more chance — careful!');
          } else {
            state.done = true; state.burst = true;
            setMessage('It burst! You lose. Tap Retry.', 'lose');
            showGameOver(false);
          }
        } else {
          state.cuts++;
          renderDots(); updateHUD(); passBeep();
          placePiece(state.cuts - 1);
          if (state.cuts >= MAX_CUTS) {
            state.done = true; winJingle();
            setMessage('Perfect! 10 clean cuts. You win!', 'win');
            showGameOver(true);
          } else {
            setMessage('Clean cut! Keep going...');
          }
        }
      }, 120);
    }

    function resetGame(){
      state.cuts = 0; state.done = false; state.burst = false; state.started = false; state.extraLifeUsed = false;
      crack.classList.remove('show');
      document.getElementById('flash')?.classList.remove('show');
      renderDots(); updateHUD();
      setMessage('Tap Start Game to begin!');
      if (piecesEl) piecesEl.innerHTML = '';
      gameOver.classList.add('hidden');
    }

    function explode(){
      const holder = document.getElementById('explosion');
      const flash = document.getElementById('flash');
      if (!holder) return;
      flash.classList.remove('show'); void flash.offsetWidth; flash.classList.add('show');
      setTimeout(()=>flash.classList.remove('show'), 160);
      const types = ['rice','nori','egg','radish','crab','spinach','burdock'];
      const count = 28 + Math.floor(Math.random()*8);
      for (let i=0;i<count;i++){
        const el = document.createElement('span');
        const t = types[Math.floor(Math.random()*types.length)];
        el.className = 'particle ' + t;
        const angle = Math.random()*Math.PI*2;
        const power = 60 + Math.random()*80;
        const dx = Math.cos(angle)*power;
        const dy = Math.sin(angle)*power - 10;
        const rot = (Math.random()*720-360)+'deg';
        el.style.setProperty('--dx', dx.toFixed(1)+'px');
        el.style.setProperty('--dy', dy.toFixed(1)+'px');
        el.style.setProperty('--rot', rot);
        holder.appendChild(el);
        el.addEventListener('animationend', ()=>{ el.remove(); });
      }
    }

    // Input bindings
    cutBtn.addEventListener('click', doCut);
    resetBtn.addEventListener('click', ()=>{ resetGame(); });
    startBtn.addEventListener('click', () => {
      state.started = true;
      document.getElementById('startOverlay').classList.add('hidden');
      startBtn.disabled = true;
      startMusic();
      setMessage('Music on. Tap Cut to slice!');
    });
    retryBtn.addEventListener('click', () => { resetGame(); state.started = true; document.getElementById('startOverlay').classList.add('hidden'); setMessage('Tap Cut to slice!'); });
    musicBtn.addEventListener('click', toggleMusic);
    document.querySelector('.board').addEventListener('click', (e)=>{ if ((e.target.closest('#resetBtn'))) return; doCut(); });
    window.addEventListener('keydown', (e)=>{
      if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); doCut(); }
      if (e.code === 'KeyR') { resetGame(); }
    });

    // Initialize
    renderDots(); updateHUD();
  })();
  </script>
</body>
</html>
