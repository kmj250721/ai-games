<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Born Hater - Slice 'n Score</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Ï¥àÍ∏∞ ÏÑ§Ï†ï ÌôîÎ©¥ */
        .setup-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .setup-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 95vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .setup-title {
            text-align: center;
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
            flex-shrink: 0;
        }

        .title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .music-icon-btn {
            position: absolute;
            left: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4ecdc4;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .music-icon-btn:hover {
            background: #45b7b8;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .music-icon-btn.playing {
            background: #e74c3c;
        }

        .help-button {
            position: absolute;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4ecdc4;
            color: white;
            border: none;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .help-button:hover {
            background: #45b7b8;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .image-item {
            border: 3px dashed #ddd;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .image-item.dragover {
            border-color: #4ecdc4;
            background-color: rgba(78, 205, 196, 0.1);
        }

        .image-item.has-image {
            border-color: #4ecdc4;
            border-style: solid;
        }

        .image-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        .image-item.has-image .emoji-display {
            display: none;
        }

        .upload-text {
            color: #666;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .emoji-display {
            font-size: 60px;
            margin-bottom: 10px;
            display: block;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            padding: 8px 16px;
            background: #4ecdc4;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .upload-button:hover {
            background: #45b7b8;
        }

        .ment-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 12px;
            margin-top: 10px;
            display: block;
        }

        .points-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .size-display {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(78, 205, 196, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        .start-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .start-button:hover {
            transform: scale(1.05);
        }

        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .music-section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .music-title {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #333;
            font-weight: bold;
        }

        .music-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .music-input:focus {
            border-color: #4ecdc4;
            outline: none;
        }

        .music-info {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }

        .volume-control {
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .play-music-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 10px;
            transition: background-color 0.3s;
        }

        .play-music-btn:hover {
            background: #45b7b8;
        }

        .play-music-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .volume-control label {
            font-size: 14px;
            color: #333;
            font-weight: bold;
        }

        .volume-control input[type="range"] {
            flex: 1;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
        }

        .volume-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
        }

        .volume-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #4ecdc4;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        #volumeValue {
            font-size: 12px;
            color: #666;
            font-weight: bold;
            min-width: 35px;
        }

        /* Í≤åÏûÑ ÌôîÎ©¥ */
        .game-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .game-ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 100;
        }

        .message-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .message-display.show {
            opacity: 1;
        }

        .points-earned {
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        /* Í≤åÏûÑ Ï¢ÖÎ£å ÌôîÎ©¥ */
        .end-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .end-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .end-title {
            font-size: 2.5em;
            margin-bottom: 30px;
            color: #333;
        }

        .score-summary {
            margin-bottom: 30px;
        }

        .total-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 20px;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .score-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }

        .score-card-image {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 10px;
            display: block;
        }

        .score-card-info {
            font-size: 12px;
            color: #666;
        }

        .score-card-count {
            font-weight: bold;
            color: #333;
        }

        .restart-button {
            padding: 15px 30px;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .restart-button:hover {
            transform: scale(1.05);
        }

        /* Í≤åÏûÑ Î£∞ Î™®Îã¨ */
        .rules-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .rules-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            position: relative;
        }

        .rules-title {
            font-size: 1.6em;
            margin-bottom: 15px;
            color: #333;
            text-align: center;
            font-weight: bold;
        }

        .rules-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .rules-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }

        .rules-section h3 {
            color: #4ecdc4;
            font-size: 1em;
            margin-bottom: 6px;
            font-weight: bold;
        }

        .rules-section p {
            color: #666;
            line-height: 1.4;
            margin: 0;
            font-size: 13px;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .close-button:hover {
            background: #ee5a24;
        }

        /* ÏùåÏïÖ Î™®Îã¨ */
        .music-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .music-modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .music-modal-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .music-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .music-url-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .music-url-input:focus {
            border-color: #4ecdc4;
        }

        .play-music-btn {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .play-music-btn:hover:not(:disabled) {
            background: #45b7b8;
        }

        .play-music-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .music-info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
        }

        .music-status {
            font-size: 14px;
            color: #4ecdc4;
            text-align: center;
            font-weight: bold;
        }

        /* Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
        @media (max-width: 768px) {
            .setup-content {
                padding: 15px;
                margin: 5px;
                max-height: 98vh;
            }
            
            .setup-title {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
            
            .image-grid {
                grid-template-columns: 1fr;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .image-item {
                min-height: 180px;
                padding: 12px;
            }
            
            .image-preview {
                width: 80px;
                height: 80px;
            }
            
            .emoji-display {
                font-size: 50px;
            }
            
            .upload-text {
                font-size: 11px;
            }
            
            .upload-button {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .ment-input {
                padding: 6px;
                font-size: 11px;
            }
            
            .start-button {
                padding: 10px;
                font-size: 14px;
                margin-top: 10px;
            }
            
            .game-ui, .timer {
                font-size: 20px;
            }
            
            .message-display {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ï¥àÍ∏∞ ÏÑ§Ï†ï ÌôîÎ©¥ -->
        <div class="setup-screen" id="setupScreen">
            <div class="setup-content">
                <div class="title-container">
                    <button class="music-icon-btn" onclick="showMusicModal()" title="Add Background Music">üéµ</button>
                    <h1 class="setup-title">Born Hater</h1>
                    <button class="help-button" onclick="showGameRules()" title="View Game Rules">?</button>
                </div>
                
                <div class="image-grid" id="imageGrid">
                    <div class="image-item" data-rank="1">
                        <div class="points-display">50pts</div>
                        <div class="size-display">30px</div>
                        <img class="image-preview" alt="Image 1">
                        <div class="emoji-display">üêç</div>
                        <div class="upload-text">Drag or click to customize</div>
                        <input type="file" class="file-input" accept="image/*" data-rank="1">
                        <button class="upload-button" onclick="document.querySelector('input[data-rank=&quot;1&quot;]').click()">Customize</button>
                        <input type="text" class="ment-input" placeholder="Enter message to display when eliminated" data-rank="1" value="Got 'em!">
                    </div>
                    <div class="image-item" data-rank="2">
                        <div class="points-display">40pts</div>
                        <div class="size-display">40px</div>
                        <img class="image-preview" alt="Image 2">
                        <div class="emoji-display">üï∑Ô∏è</div>
                        <div class="upload-text">Drag or click to customize</div>
                        <input type="file" class="file-input" accept="image/*" data-rank="2">
                        <button class="upload-button" onclick="this.parentElement.querySelector('.file-input').click()">Customize</button>
                        <input type="text" class="ment-input" placeholder="Enter message to display when eliminated" data-rank="2" value="Squashed!">
                    </div>
                    <div class="image-item" data-rank="3">
                        <div class="points-display">30pts</div>
                        <div class="size-display">50px</div>
                        <img class="image-preview" alt="Image 3">
                        <div class="emoji-display">ü™±</div>
                        <div class="upload-text">Drag or click to customize</div>
                        <input type="file" class="file-input" accept="image/*" data-rank="3">
                        <button class="upload-button" onclick="this.parentElement.querySelector('.file-input').click()">Customize</button>
                        <input type="text" class="ment-input" placeholder="Enter message to display when eliminated" data-rank="3" value="Done!">
                    </div>
                    <div class="image-item" data-rank="4">
                        <div class="points-display">20pts</div>
                        <div class="size-display">60px</div>
                        <img class="image-preview" alt="Image 4">
                        <div class="emoji-display">ü¶ó</div>
                        <div class="upload-text">Drag or click to customize</div>
                        <input type="file" class="file-input" accept="image/*" data-rank="4">
                        <button class="upload-button" onclick="this.parentElement.querySelector('.file-input').click()">Customize</button>
                        <input type="text" class="ment-input" placeholder="Enter message to display when eliminated" data-rank="4" value="Bye!">
                    </div>
                    <div class="image-item" data-rank="5">
                        <div class="points-display">10pts</div>
                        <div class="size-display">70px</div>
                        <img class="image-preview" alt="Image 5">
                        <div class="emoji-display">üí©</div>
                        <div class="upload-text">Drag or click to customize</div>
                        <input type="file" class="file-input" accept="image/*" data-rank="5">
                        <button class="upload-button" onclick="this.parentElement.querySelector('.file-input').click()">Customize</button>
                        <input type="text" class="ment-input" placeholder="Enter message to display when eliminated" data-rank="5" value="Oops!">
                    </div>
                </div>

                <button class="start-button" id="startButton" onclick="startGame()" disabled>Start Game</button>
            </div>
        </div>

        <!-- Í≤åÏûÑ ÌôîÎ©¥ -->
        <div class="game-screen" id="gameScreen">
            <canvas id="gameCanvas"></canvas>
            <div class="game-ui" id="scoreDisplay">Score: 0</div>
            <div class="timer" id="timer">60</div>
            <div class="message-display" id="messageDisplay"></div>
        </div>

        <!-- Í≤åÏûÑ Ï¢ÖÎ£å ÌôîÎ©¥ -->
        <div class="end-screen" id="endScreen">
            <div class="end-content">
                <h1 class="end-title">Game Over!</h1>
                <div class="score-summary" id="scoreSummary"></div>
                <button class="restart-button" onclick="restartGame()">Play Again</button>
            </div>
        </div>

        <!-- Í≤åÏûÑ Î£∞ Î™®Îã¨ -->
        <div class="rules-modal" id="rulesModal">
            <div class="rules-content">
                <button class="close-button" onclick="hideGameRules()">√ó</button>
                <h1 class="rules-title">Game Rules</h1>
                
                <div class="rules-grid">
                    <div class="rules-section">
                        <h3>üéØ Objective</h3>
                        <p>Slice shapes with mouse to earn points!</p>
                    </div>

                    <div class="rules-section">
                        <h3>üéÆ Controls</h3>
                        <p><strong>Mouse Drag</strong>: Slice shapes<br>
                        <strong>Right-click</strong>: Trail effect</p>
                    </div>

                    <div class="rules-section">
                        <h3>‚≠ê Scoring</h3>
                        <p>Rank 1: 50pts (smallest)<br>
                        Rank 2: 40pts ‚Üí Rank 5: 10pts (largest)</p>
                    </div>

                    <div class="rules-section">
                        <h3>‚è∞ Time</h3>
                        <p>60 seconds to score maximum points!</p>
                    </div>

                    <div class="rules-section">
                        <h3>üé® Customize</h3>
                        <p>Upload images & set messages for each shape</p>
                    </div>

                    <div class="rules-section">
                        <h3>üí° Tips</h3>
                        <p>Smaller = harder but more points!<br>
                        Slice before they disappear!</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- ÏùåÏïÖ ÏÑ§Ï†ï Î™®Îã¨ -->
        <div class="music-modal" id="musicModal">
            <div class="music-modal-content">
                <h3 class="music-modal-title">Background Music</h3>
                <div class="music-input-group">
                    <input type="url" class="music-url-input" id="musicUrl" placeholder="Enter YouTube URL">
                    <button class="play-music-btn" id="playMusicBtn" disabled>‚ñ∂ Play</button>
                </div>
                <div class="music-info">Paste a YouTube URL to play music during the game</div>
                <div class="music-status" id="musicStatus"></div>
                <button class="close-button" onclick="hideMusicModal()">√ó</button>
            </div>
        </div>

    </div>

    <script>
        // Í≤åÏûÑ ÏÉÅÏàò
        const MAX_HEIGHT_RANGE = 0.6; // ÌôîÎ©¥ ÎÜíÏù¥Ïùò 60%ÍπåÏßÄ Ïò¨ÎùºÍ∞à Ïàò ÏûàÏùå

        // Í≤åÏûÑ ÏÉÅÌÉú
        let gameState = {
            isPlaying: false,
            score: 0,
            timeLeft: 60,
            shapes: [],
            gameData: null,
            canvas: null,
            ctx: null,
            animationId: null,
            audioContext: null,
            audioSource: null,
            shapeStats: {}, // Í∞Å ÎèÑÌòïÎ≥Ñ ÌÜµÍ≥Ñ
            musicUrl: null,
            musicPlayer: null,
            isMusicMuted: false,
            volume: 50
        };

        // ÎèÑÌòï ÌÅ¥ÎûòÏä§
        class Shape {
            constructor(image, ment, rank, startX, startY, targetX, targetY) {
                this.image = image;
                this.ment = ment;
                this.rank = rank;
                this.x = startX;
                this.y = startY;
                this.targetX = targetX;
                this.targetY = targetY;
                
                // Ìè¨Î¨ºÏÑ† Ïö¥ÎèôÏùÑ ÏúÑÌïú Ï¥àÍ∏∞ ÏÜçÎèÑ Í≥ÑÏÇ∞
                const dx = targetX - startX;
                const dy = targetY - startY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const speed = (6 - rank) * 0.5 + 2; // ÏàúÏúÑÍ∞Ä ÎÜíÏùÑÏàòÎ°ù Îπ†Î¶Ñ
                
                this.vx = (dx / distance) * speed;
                this.vy = (dy / distance) * speed;
                this.gravity = 0.1;
                
                this.size = 30 + (rank - 1) * 10; // ÏàúÏúÑÍ∞Ä ÎÜíÏùÑÏàòÎ°ù ÏûëÏùå (1ÏàúÏúÑ: 30px, 5ÏàúÏúÑ: 70px)
                this.points = (6 - rank) * 10; // ÏàúÏúÑÍ∞Ä ÎÜíÏùÑÏàòÎ°ù ÎÜíÏùÄ Ï†êÏàò
                this.isCut = false;
                this.cutTime = 0;
                this.maxHeight = gameState.canvas.height * MAX_HEIGHT_RANGE;
            }

            update() {
                if (!this.isCut) {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += this.gravity;
                } else {
                    this.cutTime++;
                }
            }

            draw(ctx) {
                if (!this.isCut) {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    
                    // 1. ÏõêÌòï Î∞∞Í≤Ω Í∑∏Î¶¨Í∏∞
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                    ctx.fillStyle = '#4ecdc4';
                    ctx.fill();
                    
                    // 2. ÏõêÌòï ÌÖåÎëêÎ¶¨ Í∑∏Î¶¨Í∏∞ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // 3. Ïù¥ÎØ∏ÏßÄÎ•º ÏõêÌòï Î∞∞Í≤Ω ÏúÑÏóê Í∑∏Î¶¨Í∏∞ (ÏõêÌòï ÎßàÏä§ÌÅ¨ Ï†ÅÏö©)
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                    ctx.clip();
                    
                    // Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞ (ÏõêÌòï ÏòÅÏó≠Ïùò 80% ÌÅ¨Í∏∞Î°ú Ï°∞Ï†ï)
                    const imageSize = this.size * 0.8;
                    const aspectRatio = this.image.width / this.image.height;
                    let drawWidth, drawHeight, offsetX, offsetY;
                    
                    if (aspectRatio > 1) {
                        // Í∞ÄÎ°úÍ∞Ä Îçî Í∏¥ Í≤ΩÏö∞
                        drawWidth = imageSize;
                        drawHeight = imageSize / aspectRatio;
                    } else {
                        // ÏÑ∏Î°úÍ∞Ä Îçî Í∏¥ Í≤ΩÏö∞
                        drawHeight = imageSize;
                        drawWidth = imageSize * aspectRatio;
                    }
                    
                    // Ïù¥ÎØ∏ÏßÄÎ•º ÏõêÌòïÏùò Ï†ïÏ§ëÏïôÏóê Î∞∞Ïπò
                    offsetX = -drawWidth / 2;
                    offsetY = -drawHeight / 2;
                    
                    ctx.drawImage(this.image, offsetX, offsetY, drawWidth, drawHeight);
                    ctx.restore();
                    ctx.restore();
                }
            }

            isOffScreen() {
                return this.y > gameState.canvas.height + 50 || this.x < -50 || this.x > gameState.canvas.width + 50;
            }
        }

        // Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            initializeSetup();
            initializeMusicInput();
        });

        // ÏùåÏïÖ Î™®Îã¨ ÌëúÏãú
        function showMusicModal() {
            document.getElementById('musicModal').style.display = 'flex';
        }

        // ÏùåÏïÖ Î™®Îã¨ Ïà®Í∏∞Í∏∞
        function hideMusicModal() {
            document.getElementById('musicModal').style.display = 'none';
        }

        // ÏùåÏïÖ ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        function initializeMusicInput() {
            const musicInput = document.getElementById('musicUrl');
            const playMusicBtn = document.getElementById('playMusicBtn');
            const musicStatus = document.getElementById('musicStatus');
            const musicIconBtn = document.querySelector('.music-icon-btn');

            // URL ÏûÖÎ†• Ïãú ÏùåÏïÖ Ï§ÄÎπÑ
            musicInput.addEventListener('input', function() {
                const url = this.value.trim();
                if (url && isValidYouTubeUrl(url)) {
                    startBackgroundMusic(url);
                    playMusicBtn.disabled = false;
                    playMusicBtn.textContent = '‚ñ∂ Play';
                    musicStatus.textContent = 'Ready to play!';
                    musicIconBtn.classList.add('playing');
                } else {
                    stopBackgroundMusic();
                    playMusicBtn.disabled = true;
                    playMusicBtn.textContent = '‚ñ∂ Play';
                    musicStatus.textContent = '';
                    musicIconBtn.classList.remove('playing');
                }
            });

            // Ïû¨ÏÉù Î≤ÑÌäº ÌÅ¥Î¶≠
            playMusicBtn.addEventListener('click', function() {
                if (gameState.musicPlayer) {
                    gameState.musicPlayer.play();
                    this.textContent = '‚è∏ Playing';
                    this.disabled = true;
                    musicStatus.textContent = 'Music is playing!';
                    setTimeout(() => {
                        this.disabled = false;
                        this.textContent = '‚ñ∂ Play';
                        musicStatus.textContent = 'Music loaded successfully!';
                    }, 2000);
                }
            });

            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            document.getElementById('musicModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    hideMusicModal();
                }
            });

            // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideMusicModal();
                }
            });
        }

        // Ïú†ÌäúÎ∏å URL Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
        function isValidYouTubeUrl(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11);
        }

        // Î∞∞Í≤Ω ÏùåÏïÖ ÏãúÏûë
        function startBackgroundMusic(url) {
            try {
                const videoId = extractYouTubeVideoId(url);
                if (!videoId) {
                    console.log('Invalid YouTube URL:', url);
                    return;
                }

                // Í∏∞Ï°¥ ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
                if (gameState.musicPlayer) {
                    stopBackgroundMusic();
                }

                // Ïà®Í≤®ÏßÑ iframe ÏÉùÏÑ± (autoplay Ï†úÍ±∞ÌïòÍ≥† ÏàòÎèô Ïû¨ÏÉù)
                const iframe = document.createElement('iframe');
                iframe.src = `https://www.youtube.com/embed/${videoId}?controls=0&disablekb=1&fs=0&modestbranding=1&playsinline=1&rel=0&showinfo=0&loop=1&playlist=${videoId}&enablejsapi=1`;
                iframe.style.display = 'none';
                iframe.width = '0';
                iframe.height = '0';
                iframe.id = 'backgroundMusicPlayer';
                iframe.allow = 'autoplay; encrypted-media';
                document.body.appendChild(iframe);

                // iframe Î°úÎìú ÏôÑÎ£å ÌõÑ Ïû¨ÏÉù ÏãúÎèÑ
                iframe.onload = function() {
                    console.log('YouTube iframe loaded, attempting to play...');
                    // ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ ÌõÑ Ïû¨ÏÉù ÏãúÎèÑ (Î∏åÎùºÏö∞Ï†Ä Ï†ïÏ±Ö ÎïåÎ¨∏)
                    setTimeout(() => {
                        tryPlayMusic(iframe, videoId);
                    }, 1000);
                };

                gameState.musicPlayer = {
                    iframe: iframe,
                    videoId: videoId,
                    mute: () => {
                        iframe.src = iframe.src.replace('&mute=0', '') + '&mute=1';
                    },
                    unMute: () => {
                        iframe.src = iframe.src.replace('&mute=1', '') + '&mute=0';
                    },
                    pause: () => {
                        iframe.src = iframe.src.replace('&autoplay=1', '');
                    },
                    play: () => {
                        tryPlayMusic(iframe, videoId);
                    }
                };

                gameState.musicUrl = url;
                console.log('Background music iframe created for:', url);

            } catch (error) {
                console.log('Error starting background music:', error);
            }
        }

        // ÏùåÏïÖ Ïû¨ÏÉù ÏãúÎèÑ
        function tryPlayMusic(iframe, videoId) {
            try {
                // autoplay ÌååÎùºÎØ∏ÌÑ∞Î•º Ï∂îÍ∞ÄÌïòÏó¨ Ïû¨ÏÉù ÏãúÎèÑ
                const currentSrc = iframe.src;
                if (!currentSrc.includes('autoplay=1')) {
                    iframe.src = currentSrc + '&autoplay=1';
                }
                console.log('Attempting to play music with autoplay=1');
            } catch (error) {
                console.log('Error trying to play music:', error);
            }
        }

        // Î∞∞Í≤Ω ÏùåÏïÖ Ï§ëÏßÄ
        function stopBackgroundMusic() {
            if (gameState.musicPlayer && gameState.musicPlayer.iframe) {
                gameState.musicPlayer.iframe.remove();
                gameState.musicPlayer = null;
                gameState.musicUrl = null;
            }
        }

        // Ïú†ÌäúÎ∏å URLÏóêÏÑú ÎπÑÎîîÏò§ ID Ï∂îÏ∂ú
        function extractYouTubeVideoId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }


        // ÏÑ§Ï†ï ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
        function initializeSetup() {
            // ÎìúÎûòÍ∑∏ Ïï§ ÎìúÎ°≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
            const imageItems = document.querySelectorAll('.image-item');
            imageItems.forEach(item => {
                const rank = item.dataset.rank;
                const fileInput = item.querySelector('.file-input');
                const preview = item.querySelector('.image-preview');
                const mentInput = item.querySelector('.ment-input');
                const uploadText = item.querySelector('.upload-text');

                // ÎìúÎûòÍ∑∏ Ïù¥Î≤§Ìä∏
                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    item.classList.add('dragover');
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('dragover');
                });

                item.addEventListener('drop', (e) => {
                    e.preventDefault();
                    item.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileUpload(files[0], rank);
                    }
                });

                // ÌååÏùº ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileUpload(e.target.files[0], rank);
                    }
                });
            });

            // Ï¥àÍ∏∞ ÏÉÅÌÉú Ï≤¥ÌÅ¨ - Ïù¥Ï†ú Í∏∞Î≥∏ Ïù¥Î™®ÏßÄÎ°ú Í≤åÏûÑ ÏãúÏûë Í∞ÄÎä•
            checkAllImagesReady();
        }

        // ÌååÏùº ÏóÖÎ°úÎìú Ï≤òÎ¶¨
        function handleFileUpload(file, rank) {
            if (!file.type.startsWith('image/')) {
                alert('Only image files are allowed.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const item = document.querySelector(`[data-rank="${rank}"]`);
                    const preview = item.querySelector('.image-preview');
                    const mentInput = item.querySelector('.ment-input');
                    const uploadText = item.querySelector('.upload-text');
                    const uploadButton = item.querySelector('.upload-button');

                    preview.src = e.target.result;
                    preview.classList.add('show');
                    uploadText.style.display = 'none';
                    uploadButton.style.display = 'none';
                    item.classList.add('has-image');
                    
                    // ÌååÏùº Í∞ùÏ≤¥Î•º Îç∞Ïù¥ÌÑ∞ ÏÜçÏÑ±Ïóê Ï†ÄÏû•
                    item.dataset.file = JSON.stringify({
                        name: file.name,
                        type: file.type,
                        size: file.size
                    });

                    checkAllImagesReady();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Î™®Îì† Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï§ÄÎπÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏
        function checkAllImagesReady() {
            const allItems = document.querySelectorAll('.image-item');
            let allReady = true;

            allItems.forEach(item => {
                const mentInput = item.querySelector('.ment-input');
                if (!mentInput.value.trim()) {
                    allReady = false;
                }
            });

            const startButton = document.getElementById('startButton');
            startButton.disabled = !allReady;
        }

        // Î©òÌä∏ ÏûÖÎ†• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('ment-input')) {
                checkAllImagesReady();
            }
        });

        // Ïù¥Î™®ÏßÄ Î≤ÑÌäºÏúºÎ°úÎèÑ Í≤åÏûÑ ÏãúÏûë Í∞ÄÎä•ÌïòÎèÑÎ°ù Ï≤¥ÌÅ¨
        document.addEventListener('DOMContentLoaded', function() {
            checkAllImagesReady();
        });

        // Í≤åÏûÑ ÏãúÏûë
        function startGame() {
            const gameData = {
                shapes: [],
                musicUrl: null // ÏùåÏïÖ Í∏∞Îä• Ï†úÍ±∞
            };

            // ÎèÑÌòï Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
            for (let i = 1; i <= 5; i++) {
                const item = document.querySelector(`[data-rank="${i}"]`);
                const preview = item.querySelector('.image-preview');
                const mentInput = item.querySelector('.ment-input');
                const emojiDisplay = item.querySelector('.emoji-display');

                const img = new Image();
                const shapeData = {
                    ment: mentInput.value.trim(),
                    rank: i
                };

                // Ïª§Ïä§ÌÖÄ Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Ïù¥Î™®ÏßÄÎ•º Ï∫îÎ≤ÑÏä§Î°ú Î≥ÄÌôò
                if (preview.classList.contains('show')) {
                    img.onload = function() {
                        shapeData.image = img;
                        gameData.shapes.push(shapeData);
                        
                        if (gameData.shapes.length === 5) {
                            initializeGame(gameData);
                        }
                    };
                    img.src = preview.src;
                } else {
                    // Ïù¥Î™®ÏßÄÎ•º Ï∫îÎ≤ÑÏä§Î°ú Î≥ÄÌôò (Î∞∞Í≤Ω ÏóÜÏù¥ Ïù¥Î™®ÏßÄÎßå)
                    const emoji = emojiDisplay.textContent;
                    const canvas = document.createElement('canvas');
                    canvas.width = 128;
                    canvas.height = 128;
                    const ctx = canvas.getContext('2d');
                    
                    // Ïù¥Î™®ÏßÄÎ•º Ï∫îÎ≤ÑÏä§ Ï§ëÏïôÏóê Í∑∏Î¶¨Í∏∞
                    ctx.font = '100px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(emoji, 64, 64);
                    
                    const dataUrl = canvas.toDataURL();
                    img.onload = function() {
                        shapeData.image = img;
                        gameData.shapes.push(shapeData);
                        
                        if (gameData.shapes.length === 5) {
                            initializeGame(gameData);
                        }
                    };
                    img.src = dataUrl;
                }
            }
        }

        // Í≤åÏûÑ Ï¥àÍ∏∞Ìôî
        function initializeGame(data) {
            gameState.gameData = data;
            gameState.canvas = document.getElementById('gameCanvas');
            gameState.ctx = gameState.canvas.getContext('2d');
            
            // ÌÜµÍ≥Ñ Ï¥àÍ∏∞Ìôî
            gameState.shapeStats = {};
            data.shapes.forEach(shapeData => {
                gameState.shapeStats[shapeData.rank] = {
                    count: 0,
                    points: 0,
                    image: shapeData.image,
                    ment: shapeData.ment
                };
            });
            
            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ ÏÑ§Ï†ï
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // ÌôîÎ©¥ Ï†ÑÌôò
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';

            // Í≤åÏûÑ ÏãúÏûë
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.timeLeft = 60;
            gameState.shapes = [];

            // ÌÉÄÏù¥Î®∏ ÏãúÏûë
            const timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(timer);
                    endGame();
                }
            }, 1000);

            // Í≤åÏûÑ Î£®ÌîÑ ÏãúÏûë
            gameLoop();
        }

        // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞ Ï°∞Ï†ï
        function resizeCanvas() {
            gameState.canvas.width = window.innerWidth;
            gameState.canvas.height = window.innerHeight;
        }

        // Í≤åÏûÑ Î£®ÌîÑ
        function gameLoop() {
            if (!gameState.isPlaying) return;

            // Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶¨Ïñ¥
            gameState.ctx.clearRect(0, 0, gameState.canvas.width, gameState.canvas.height);

            // ÎèÑÌòï ÏÉùÏÑ± (ÎûúÎç§)
            if (Math.random() < 0.02) {
                const shapeData = gameState.gameData.shapes[Math.floor(Math.random() * gameState.gameData.shapes.length)];
                
                // ÎûúÎç§Ìïú Í∞ÄÏû•ÏûêÎ¶¨ÏóêÏÑú ÏãúÏûë
                const edge = Math.floor(Math.random() * 3); // 0: Ï¢åÏ∏°, 1: Ïö∞Ï∏°, 2: ÌïòÎã®
                let startX, startY, targetX, targetY;
                
                switch (edge) {
                    case 0: // Ï¢åÏ∏° Í∞ÄÏû•ÏûêÎ¶¨
                        startX = -50;
                        startY = Math.random() * gameState.canvas.height;
                        targetX = gameState.canvas.width + 50;
                        targetY = Math.random() * gameState.canvas.height * MAX_HEIGHT_RANGE;
                        break;
                    case 1: // Ïö∞Ï∏° Í∞ÄÏû•ÏûêÎ¶¨
                        startX = gameState.canvas.width + 50;
                        startY = Math.random() * gameState.canvas.height;
                        targetX = -50;
                        targetY = Math.random() * gameState.canvas.height * MAX_HEIGHT_RANGE;
                        break;
                    case 2: // ÌïòÎã® Í∞ÄÏû•ÏûêÎ¶¨
                        startX = Math.random() * gameState.canvas.width;
                        startY = gameState.canvas.height + 50;
                        targetX = Math.random() * gameState.canvas.width;
                        targetY = Math.random() * gameState.canvas.height * MAX_HEIGHT_RANGE;
                        break;
                }
                
                gameState.shapes.push(new Shape(
                    shapeData.image,
                    shapeData.ment,
                    shapeData.rank,
                    startX, startY,
                    targetX, targetY
                ));
            }

            // ÎèÑÌòï ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Í∑∏Î¶¨Í∏∞
            gameState.shapes = gameState.shapes.filter(shape => {
                shape.update();
                shape.draw(gameState.ctx);
                return !shape.isOffScreen() && shape.cutTime < 60;
            });

            // ÎìúÎûòÍ∑∏ Í∂§Ï†Å Í∑∏Î¶¨Í∏∞ (ÎèÑÌòï ÏúÑÏóê)
            drawDragTrail();

            // Ìä∏Î†àÏùº Ìö®Í≥º Í∑∏Î¶¨Í∏∞ (ÏµúÏÉÅÏúÑ, Ïö∞ÌÅ¥Î¶≠ Ï§ëÏùº Îïå)
            if (isDragging && isRightClick) {
                drawTrail();
            }

            // Ï†êÏàò ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('scoreDisplay').textContent = `Score: ${gameState.score}`;

            gameState.animationId = requestAnimationFrame(gameLoop);
        }

        // ÎßàÏö∞Ïä§/ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        let isDragging = false;
        let isRightClick = false;
        let lastX = 0;
        let lastY = 0;
        let trailPoints = [];
        let dragTrail = []; // Ï¢åÌÅ¥Î¶≠ ÎìúÎûòÍ∑∏ Í∂§Ï†Å Ï†ÄÏû•

        function initializeGameEvents() {
            gameState.canvas.addEventListener('mousedown', startDrag);
            gameState.canvas.addEventListener('mousemove', drag);
            gameState.canvas.addEventListener('mouseup', endDrag);
            gameState.canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            gameState.canvas.addEventListener('touchstart', startDrag);
            gameState.canvas.addEventListener('touchmove', drag);
            gameState.canvas.addEventListener('touchend', endDrag);
        }

        function startDrag(e) {
            const rect = gameState.canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            lastX = clientX - rect.left;
            lastY = clientY - rect.top;
            
            // Ïö∞ÌÅ¥Î¶≠ Í∞êÏßÄ
            if (e.button === 2 || e.which === 3) {
                isRightClick = true;
                isDragging = true;
                trailPoints = [{x: lastX, y: lastY, time: Date.now()}];
            } else if (e.button === 0 || e.which === 1 || e.touches) {
                isRightClick = false;
                isDragging = true;
                trailPoints = [{x: lastX, y: lastY, time: Date.now()}];
            }
        }

        function drag(e) {
            if (!isDragging) return;
            
            e.preventDefault();
            const rect = gameState.canvas.getBoundingClientRect();
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            
            const currentX = clientX - rect.left;
            const currentY = clientY - rect.top;

            // Ìä∏Î†àÏùº Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä
            trailPoints.push({x: currentX, y: currentY, time: Date.now()});
            
            // Ïò§ÎûòÎêú Ìä∏Î†àÏùº Ìè¨Ïù∏Ìä∏ Ï†úÍ±∞ (1Ï¥à Ïù¥ÏÉÅ Îêú Í≤ÉÎì§)
            const now = Date.now();
            trailPoints = trailPoints.filter(point => now - point.time < 1000);

            if (isRightClick) {
                // Ïö∞ÌÅ¥Î¶≠ Ïãú Ìä∏Î†àÏùº Ìö®Í≥ºÎßå (Ï∂©Îèå Í≤ÄÏÇ¨ ÏóÜÏùå)
                drawTrail();
            } else {
                // Ï¢åÌÅ¥Î¶≠/ÌÑ∞Ïπò Ïãú ÎìúÎûòÍ∑∏ Í∂§Ï†Å Ï†ÄÏû•
                dragTrail.push({x: currentX, y: currentY, time: Date.now()});
                
                // Ïò§ÎûòÎêú ÎìúÎûòÍ∑∏ Í∂§Ï†Å Ï†úÍ±∞ (3Ï¥à Ïù¥ÏÉÅ Îêú Í≤ÉÎì§)
                const now = Date.now();
                dragTrail = dragTrail.filter(point => now - point.time < 3000);

                // Ï∂©Îèå Í≤ÄÏÇ¨
                checkCollisions(lastX, lastY, currentX, currentY);
            }

            lastX = currentX;
            lastY = currentY;
        }

        function drawTrail() {
            if (trailPoints.length < 2) return;
            
            for (let i = 1; i < trailPoints.length; i++) {
                const point = trailPoints[i];
                const prevPoint = trailPoints[i - 1];
                const age = Date.now() - point.time;
                const alpha = Math.max(0, 1 - age / 1000);
                
                gameState.ctx.strokeStyle = `rgba(255, 107, 107, ${alpha})`;
                gameState.ctx.lineWidth = 3;
                gameState.ctx.lineCap = 'round';
                gameState.ctx.beginPath();
                gameState.ctx.moveTo(prevPoint.x, prevPoint.y);
                gameState.ctx.lineTo(point.x, point.y);
                gameState.ctx.stroke();
            }
        }

        function drawDragTrail() {
            if (dragTrail.length < 2) return;
            
            for (let i = 1; i < dragTrail.length; i++) {
                const point = dragTrail[i];
                const prevPoint = dragTrail[i - 1];
                const age = Date.now() - point.time;
                const alpha = Math.max(0, 1 - age / 3000); // 3Ï¥à ÎèôÏïà ÌéòÏù¥ÎìúÏïÑÏõÉ
                
                gameState.ctx.strokeStyle = `rgba(255, 107, 107, ${alpha * 0.3})`;
                gameState.ctx.lineWidth = 3;
                gameState.ctx.lineCap = 'round';
                gameState.ctx.beginPath();
                gameState.ctx.moveTo(prevPoint.x, prevPoint.y);
                gameState.ctx.lineTo(point.x, point.y);
                gameState.ctx.stroke();
            }
        }

        function endDrag() {
            isDragging = false;
            isRightClick = false;
            trailPoints = [];
            // dragTrailÏùÄ Ïú†ÏßÄ (ÌéòÏù¥ÎìúÏïÑÏõÉ Ìö®Í≥ºÎ•º ÏúÑÌï¥)
        }

        // Ï∂©Îèå Í≤ÄÏÇ¨
        function checkCollisions(x1, y1, x2, y2) {
            gameState.shapes.forEach(shape => {
                if (shape.isCut) return;

                // ÏÑ†Î∂ÑÍ≥º ÏõêÏùò Ï∂©Îèå Í≤ÄÏÇ¨
                const dx = x2 - x1;
                const dy = y2 - y1;
                const length = Math.sqrt(dx * dx + dy * dy);
                
                if (length === 0) return;

                const t = Math.max(0, Math.min(1, ((shape.x - x1) * dx + (shape.y - y1) * dy) / (length * length)));
                const closestX = x1 + t * dx;
                const closestY = y1 + t * dy;
                
                const distance = Math.sqrt((shape.x - closestX) ** 2 + (shape.y - closestY) ** 2);
                
                if (distance < shape.size / 2) {
                    // ÎèÑÌòï ÏûêÎ•¥Í∏∞
                    shape.isCut = true;
                    gameState.score += shape.points;
                    
                    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
                    gameState.shapeStats[shape.rank].count++;
                    gameState.shapeStats[shape.rank].points += shape.points;
                    
                    // Î©òÌä∏ ÌëúÏãú (Ï∂©Îèå ÏßÄÏ†êÏóêÏÑú)
                    showMessage(shape.ment, closestX, closestY, shape.points);
                }
            });
        }

        // Î©òÌä∏ ÌëúÏãú
        function showMessage(message, x, y, points) {
            const messageDisplay = document.getElementById('messageDisplay');
            
            if (points !== undefined) {
                // Ï†êÏàòÏôÄ Î©òÌä∏Î•º Ìï®Íªò ÌëúÏãú
                messageDisplay.innerHTML = `
                    <div class="points-earned">+${points}pts</div>
                    <div>${message}</div>
                `;
            } else {
                // Î©òÌä∏Îßå ÌëúÏãú
                messageDisplay.textContent = message;
            }
            
            if (x !== undefined && y !== undefined) {
                // ÎßàÏö∞Ïä§ ÏúÑÏπòÏóê ÌëúÏãú
                messageDisplay.style.left = x + 'px';
                messageDisplay.style.top = y + 'px';
                messageDisplay.style.transform = 'translate(-50%, -50%)';
            } else {
                // Í∏∞Î≥∏ Ï§ëÏïô ÏúÑÏπò
                messageDisplay.style.left = '50%';
                messageDisplay.style.top = '50%';
                messageDisplay.style.transform = 'translate(-50%, -50%)';
            }
            
            messageDisplay.classList.add('show');
            
            setTimeout(() => {
                messageDisplay.classList.remove('show');
            }, 2000);
        }

        // Í≤åÏûÑ Ï¢ÖÎ£å
        function endGame() {
            gameState.isPlaying = false;
            cancelAnimationFrame(gameState.animationId);

            // Ï¢ÖÎ£å ÌôîÎ©¥ ÌëúÏãú
            const scoreSummary = document.getElementById('scoreSummary');
            scoreSummary.innerHTML = `
                <div class="total-score">Total Score: ${gameState.score}</div>
                <div class="score-grid">
                    ${Object.entries(gameState.shapeStats).map(([rank, stats]) => `
                        <div class="score-card">
                            <img class="score-card-image" src="${stats.image.src}" alt="Shape ${rank}">
                            <div class="score-card-info">
                                <div class="score-card-count">${stats.count}</div>
                                <div>${stats.points}pts</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('endScreen').style.display = 'flex';
        }

        // Í≤åÏûÑ Ïû¨ÏãúÏûë
        function restartGame() {
            document.getElementById('endScreen').style.display = 'none';
            document.getElementById('setupScreen').style.display = 'flex';
            
            // Í≤åÏûÑ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            gameState.isPlaying = false;
            gameState.score = 0;
            gameState.shapes = [];
            gameState.shapeStats = {};
            
            // Ï∫îÎ≤ÑÏä§ ÌÅ¥Î¶¨Ïñ¥
            if (gameState.ctx) {
                gameState.ctx.clearRect(0, 0, gameState.canvas.width, gameState.canvas.height);
            }

            // Î™®Îì† Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï Ï¥àÍ∏∞Ìôî
            const emojis = ['üêç', 'üï∑Ô∏è', 'ü™±', 'ü¶ó', 'üí©'];
            const defaultMents = ["Got 'em!", 'Squashed!', 'Done!', 'Bye!', 'Oops!'];
            
            for (let i = 1; i <= 5; i++) {
                const item = document.querySelector(`[data-rank="${i}"]`);
                const preview = item.querySelector('.image-preview');
                const mentInput = item.querySelector('.ment-input');
                const emojiDisplay = item.querySelector('.emoji-display');
                const uploadText = item.querySelector('.upload-text');
                const uploadButton = item.querySelector('.upload-button');
                
                // Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞
                preview.src = '';
                preview.classList.remove('show');
                
                // Ïù¥Î™®ÏßÄ Îã§Ïãú ÌëúÏãú
                emojiDisplay.textContent = emojis[i - 1];
                emojiDisplay.style.display = 'block';
                
                // Î≤ÑÌäºÍ≥º ÌÖçÏä§Ìä∏ Îã§Ïãú ÌëúÏãú
                uploadText.style.display = 'block';
                uploadButton.style.display = 'block';
                item.classList.remove('has-image');
                
                // Î©òÌä∏ Ï¥àÍ∏∞Ìôî
                mentInput.value = defaultMents[i - 1];
                
                // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                const fileInput = item.querySelector('.file-input');
                fileInput.value = '';
            }
            
            // Ï¥àÍ∏∞Ìôî ÌõÑ ÏÉÅÌÉú Ï≤¥ÌÅ¨
            checkAllImagesReady();
        }

        // Í≤åÏûÑ Î£∞ Î™®Îã¨ ÌëúÏãú
        function showGameRules() {
            document.getElementById('rulesModal').style.display = 'flex';
        }

        // Í≤åÏûÑ Î£∞ Î™®Îã¨ Ïà®Í∏∞Í∏∞
        function hideGameRules() {
            document.getElementById('rulesModal').style.display = 'none';
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('rulesModal');
            if (e.target === modal) {
                hideGameRules();
            }
        });

        // ESC ÌÇ§Î°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideGameRules();
            }
        });

        // Í≤åÏûÑ Ïù¥Î≤§Ìä∏ Ï¥àÍ∏∞ÌôîÎ•º Í≤åÏûÑ ÏãúÏûë ÏãúÏóê Ìò∏Ï∂ú
        const originalInitializeGame = initializeGame;
        initializeGame = function(data) {
            originalInitializeGame(data);
            initializeGameEvents();
        };
    </script>
</body>
</html>
